<!doctype html>
<html lang="ja">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <title>レンダリングテスト | ゲーム管理モックアップ</title>
    <style>
      body { font-family: system-ui, sans-serif; margin: 24px; background: #f5f7fb; color: #202330; }
      h1 { font-size: 1.4rem; margin-bottom: 8px; }
      .summary { margin: 12px 0; font-weight: 600; }
      .results { padding-left: 18px; }
      .results li { margin-bottom: 6px; }
      .results li.fail { color: #c62828; }
      .results li.pass { color: #2e7d32; }
      section { margin-top: 32px; }
      pre { background: #fff; padding: 12px; border-radius: 8px; border: 1px solid #d9deef; overflow: auto; }
    </style>
  </head>
  <body>
    <h1>レンダリング簡易テスト</h1>
    <p class="summary" id="testSummary">テストを準備しています…</p>
    <ul class="results" id="testResults"></ul>

    <section>
      <h2>DOMスナップショット</h2>
      <h3>一覧描画後</h3>
      <div id="listMount"></div>
      <h3>詳細描画後</h3>
      <div id="detailMount"></div>
    </section>

    <script src="../src/app.js"></script>
    <script>
      (function () {
        const results = [];
        const summaryEl = document.getElementById('testSummary');
        const resultsEl = document.getElementById('testResults');
        const listMount = document.getElementById('listMount');
        const detailMount = document.getElementById('detailMount');
        const originalUrl = window.location.href;

        function record(passed, message, detail) {
          results.push({ passed, message, detail });
          const li = document.createElement('li');
          li.textContent = `${passed ? '✅' : '❌'} ${message}`;
          li.className = passed ? 'pass' : 'fail';
          if (!passed && detail) {
            const pre = document.createElement('pre');
            pre.textContent = detail;
            li.appendChild(pre);
          }
          resultsEl.appendChild(li);
          if (!passed && detail) {
            console.error(message, detail);
          }
        }

        function assert(condition, message, detail) {
          record(Boolean(condition), message, condition ? null : detail);
        }

        function run() {
          const api = window.__mockApp;
          if (!api) {
            record(false, 'テスト用API (__mockApp) を取得できません', 'app.js のテストフックが有効か確認してください。');
            return finalize();
          }

          // formatDate の正常系/異常系
          assert(api.formatDate('2024-01-05') === '2024/01/05', 'formatDateがISO文字列をYYYY/MM/DDに変換する');
          assert(api.formatDate('不明') === '不明', 'formatDateが不正な日付入力をそのまま返す');

          // getGameById の挙動
          assert(api.getGameById(api.games[0].id) === api.games[0], 'getGameByIdが既存IDでゲームを返す');
          assert(api.getGameById('___missing___') === undefined, 'getGameByIdが存在しないIDでundefinedを返す');

          // 一覧描画
          const listEl = document.createElement('ul');
          listEl.id = 'gameList';
          listEl.className = 'cards';
          listMount.appendChild(listEl);
          api.renderList();
          assert(listEl.children.length === api.games.length, 'renderListがゲーム件数分のカードを生成する', `children: ${listEl.children.length}`);
          const firstLink = listEl.querySelector('a');
          assert(firstLink && firstLink.getAttribute('href').includes(api.games[0].id), 'renderListのリンクがゲームIDを含む', firstLink && firstLink.getAttribute('href'));

          // 詳細描画（正常系）
          const detailArticle = document.createElement('article');
          detailArticle.id = 'detailCard';
          detailMount.appendChild(detailArticle);
          const targetGame = api.games[1];
          const urlForGame = new URL(window.location.href);
          urlForGame.search = `?id=${targetGame.id}`;
          history.replaceState(null, '', urlForGame);
          api.renderDetail();
          assert(detailArticle.textContent.includes(targetGame.title), 'renderDetailが指定IDのタイトルを表示する', detailArticle.textContent.trim());

          // 詳細描画（異常系）
          const urlInvalid = new URL(window.location.href);
          urlInvalid.search = '?id=not-found';
          history.replaceState(null, '', urlInvalid);
          api.renderDetail();
          assert(
            detailArticle.textContent.includes('該当するゲームが見つかりませんでした'),
            'renderDetailが存在しないIDでエラーメッセージを表示する',
            detailArticle.textContent.trim()
          );

          finalize();
        }

        function finalize() {
          const passedCount = results.filter(r => r.passed).length;
          const total = results.length;
          if (total === 0) {
            summaryEl.textContent = 'テストが実行されませんでした。';
            return;
          }
          summaryEl.textContent = `${passedCount} / ${total} 件成功`;
          try {
            history.replaceState(null, '', originalUrl);
          } catch (err) {
            console.warn('URLの復元に失敗しました', err);
          }
        }

        window.addEventListener('load', run);
      })();
    </script>
  </body>
</html>
